{% extends "base.html" %}
{% block title %}–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–∫–ª–∞–¥–æ–º - CRM{% endblock %}

{% block content %}
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
    <h2 style="color: #2c3e50;">üì¶ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–∫–ª–∞–¥–æ–º ({{ total }})</h2>
    <div>
        <button id="addDeliveryBtn" class="btn btn-success">üì¶ –î–æ–±–∞–≤–∏—Ç—å –ø–æ—Å—Ç–∞–≤–∫—É</button>
        <button id="writeoffBtn" class="btn btn-danger">üóëÔ∏è –°–ø–∏—Å–∞—Ç—å —Ç–æ–≤–∞—Ä</button>
        <button id="bulkUpdateBtn" class="btn btn-primary" disabled>üìä –ú–∞—Å—Å–æ–≤–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ</button>
        <button id="historyBtn" class="btn btn-secondary">üìã –ò—Å—Ç–æ—Ä–∏—è –¥–≤–∏–∂–µ–Ω–∏–π</button>
    </div>
</div>

<!-- Statistics Cards -->
<div class="stats-grid">
    <div class="stat-card" style="border-left: 4px solid #17a2b8;">
        <div class="stat-number">{{ stats.total }}</div>
        <div class="stat-label">–í—Å–µ–≥–æ –≤–∏–¥–æ–≤ —Ü–≤–µ—Ç–æ–≤</div>
    </div>
</div>

<!-- Filters -->
<div class="filters">
    <form method="get">
        <input type="text" 
               name="search" 
               placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é —Ü–≤–µ—Ç–∫–∞" 
               value="{{ search_term or '' }}"
               style="min-width: 300px;">
        
        <button type="submit" class="btn btn-primary">üîç –ù–∞–π—Ç–∏</button>
        
        {% if search_term %}
        <a href="/crm/inventory" class="btn btn-secondary">‚úñ –°–±—Ä–æ—Å–∏—Ç—å</a>
        {% endif %}
    </form>
</div>

{% if flowers %}
<div class="card">
    <div style="overflow-x: auto;">
        <table>
            <thead>
                <tr>
                    <th style="width: 40px;">
                        <input type="checkbox" id="selectAll">
                    </th>
                    <th>–ù–∞–∑–≤–∞–Ω–∏–µ —Ü–≤–µ—Ç–∫–∞</th>
                    <th>–ê–Ω–≥–ª–∏–π—Å–∫–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ</th>
                    <th>–¢–µ–∫—É—â–∏–π –æ—Å—Ç–∞—Ç–æ–∫</th>
                    <th>–ù–æ–≤–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ</th>
                    <th>–°—Ç–∞—Ç—É—Å</th>
                    <th>–û–±–Ω–æ–≤–ª–µ–Ω–æ</th>
                    <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                </tr>
            </thead>
            <tbody>
                {% for flower in flowers %}
                <tr class="inventory-row" data-flower-id="{{ flower.id }}">
                    <td>
                        <input type="checkbox" class="flower-checkbox" value="{{ flower.id }}">
                    </td>
                    <td>
                        <div style="font-weight: 600;">{{ flower.name }}</div>
                        <div style="font-size: 0.8rem; color: #6c757d;">XML ID: {{ flower.xml_id }}</div>
                    </td>
                    <td>
                        <span style="color: #6c757d;">{{ flower.name_en or '-' }}</span>
                    </td>
                    <td>
                        <span class="quantity-current" 
                              style="padding: 4px 12px; border-radius: 20px; font-weight: 600; 
                              {% if flower.quantity == 0 %}background: #f8d7da; color: #721c24;{% elif flower.quantity <= 10 %}background: #fff3cd; color: #856404;{% else %}background: #d4edda; color: #155724;{% endif %}">
                            {{ flower.quantity or 0 }}
                        </span>
                    </td>
                    <td>
                        <input type="number" 
                               class="quantity-input" 
                               value="{{ flower.quantity or 0 }}" 
                               min="0" 
                               data-flower-id="{{ flower.id }}"
                               style="width: 80px; padding: 4px 8px; border: 1px solid #ced4da; border-radius: 4px;">
                    </td>
                    <td>
                        {% if flower.is_active %}
                        <span style="color: #28a745; font-weight: 600;">‚úÖ –ê–∫—Ç–∏–≤–µ–Ω</span>
                        {% else %}
                        <span style="color: #6c757d;">‚ùå –ù–µ–∞–∫—Ç–∏–≤–µ–Ω</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if flower.updated_at %}
                        <span style="font-size: 0.85rem;">
                            {{ flower.updated_at[:10] }}
                        </span>
                        {% else %}
                        <span style="color: #6c757d;">-</span>
                        {% endif %}
                    </td>
                    <td>
                        <button class="btn btn-primary update-single" 
                                data-flower-id="{{ flower.id }}" 
                                style="padding: 4px 8px; font-size: 0.8rem;">
                            üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                        </button>
                        <a href="/crm/flowers/{{ flower.id }}" 
                           class="btn btn-secondary" 
                           style="padding: 4px 8px; font-size: 0.8rem; margin-left: 4px;">
                            üëÅÔ∏è –û—Ç–∫—Ä—ã—Ç—å
                        </a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Pagination -->
{% if total_pages > 1 %}
<div class="pagination">
    {% if page > 1 %}
    <a href="?page={{ page - 1 }}{% if current_filter != 'all' %}&filter_stock={{ current_filter }}{% endif %}{% if search_term %}&search={{ search_term }}{% endif %}" class="btn btn-secondary">‚Üê –ù–∞–∑–∞–¥</a>
    {% endif %}
    
    {% for p in range(1, total_pages + 1) %}
        {% if p == page %}
        <span class="current">{{ p }}</span>
        {% else %}
        <a href="?page={{ p }}{% if current_filter != 'all' %}&filter_stock={{ current_filter }}{% endif %}{% if search_term %}&search={{ search_term }}{% endif %}">{{ p }}</a>
        {% endif %}
    {% endfor %}
    
    {% if page < total_pages %}
    <a href="?page={{ page + 1 }}{% if current_filter != 'all' %}&filter_stock={{ current_filter }}{% endif %}{% if search_term %}&search={{ search_term }}{% endif %}" class="btn btn-secondary">–í–ø–µ—Ä–µ–¥ ‚Üí</a>
    {% endif %}
</div>
{% endif %}

{% else %}
<div class="card">
    <div class="card-body" style="text-align: center; padding: 3rem;">
        <h3 style="color: #6c757d; margin-bottom: 1rem;">üì¶ –¢–æ–≤–∞—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</h3>
        <p style="color: #6c757d;">
            {% if search_term %}
            –ü–æ –∑–∞–ø—Ä–æ—Å—É "{{ search_term }}" –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.
            {% elif current_filter != 'all' %}
            –í –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ "{{ current_filter }}" —Ç–æ–≤–∞—Ä—ã –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç.
            {% else %}
            –í —Å–∏—Å—Ç–µ–º–µ –ø–æ–∫–∞ –Ω–µ—Ç —Ç–æ–≤–∞—Ä–æ–≤.
            {% endif %}
        </p>
        {% if search_term or current_filter != 'all' %}
        <a href="/crm/inventory" class="btn btn-primary">–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ —Ç–æ–≤–∞—Ä—ã</a>
        {% else %}
        <a href="/crm/products/new" class="btn btn-success">‚ûï –î–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä–≤—ã–π —Ç–æ–≤–∞—Ä</a>
        {% endif %}
    </div>
</div>
{% endif %}

<!-- Delivery Modal -->
<div id="deliveryModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 2rem; border-radius: 8px; width: 500px; max-width: 90vw;">
        <h3 style="margin-bottom: 1.5rem; color: #2c3e50;">üì¶ –î–æ–±–∞–≤–∏—Ç—å –ø–æ—Å—Ç–∞–≤–∫—É —Ç–æ–≤–∞—Ä–∞</h3>
        
        <form id="deliveryForm">
            <div style="margin-bottom: 1rem;">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">–¢–æ–≤–∞—Ä:</label>
                <select id="deliveryFlowerSelect" required style="width: 100%; padding: 8px 12px; border: 1px solid #ced4da; border-radius: 6px;">
                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–æ–≤–∞—Ä...</option>
                </select>
            </div>
            
            <div style="margin-bottom: 1rem;">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ:</label>
                <input type="number" id="deliveryQuantity" min="1" required style="width: 100%; padding: 8px 12px; border: 1px solid #ced4da; border-radius: 6px;">
            </div>
            
            <div style="margin-bottom: 1rem;">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">–î–∞—Ç–∞ –ø–æ—Å—Ç–∞–≤–∫–∏:</label>
                <input type="date" id="deliveryDate" required style="width: 100%; padding: 8px 12px; border: 1px solid #ced4da; border-radius: 6px;">
            </div>
            
            <div style="margin-bottom: 1.5rem;">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:</label>
                <textarea id="deliveryNote" rows="3" placeholder="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è..." style="width: 100%; padding: 8px 12px; border: 1px solid #ced4da; border-radius: 6px;"></textarea>
            </div>
            
            <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                <button type="button" id="cancelDelivery" class="btn btn-secondary">–û—Ç–º–µ–Ω–∞</button>
                <button type="submit" class="btn btn-success">üì¶ –î–æ–±–∞–≤–∏—Ç—å –ø–æ—Å—Ç–∞–≤–∫—É</button>
            </div>
        </form>
    </div>
</div>

<!-- Writeoff Modal -->
<div id="writeoffModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 2rem; border-radius: 8px; width: 500px; max-width: 90vw;">
        <h3 style="margin-bottom: 1.5rem; color: #2c3e50;">üóëÔ∏è –°–ø–∏—Å–∞—Ç—å —Ç–æ–≤–∞—Ä —Å–æ —Å–∫–ª–∞–¥–∞</h3>
        
        <form id="writeoffForm">
            <div style="margin-bottom: 1rem;">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">–¢–æ–≤–∞—Ä:</label>
                <select id="writeoffFlowerSelect" required style="width: 100%; padding: 8px 12px; border: 1px solid #ced4da; border-radius: 6px;">
                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–æ–≤–∞—Ä...</option>
                </select>
            </div>
            
            <div style="margin-bottom: 1rem;">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–ª—è —Å–ø–∏—Å–∞–Ω–∏—è:</label>
                <input type="number" id="writeoffQuantity" min="1" required style="width: 100%; padding: 8px 12px; border: 1px solid #ced4da; border-radius: 6px;">
                <div id="availableQuantity" style="font-size: 0.8rem; color: #6c757d; margin-top: 0.25rem;"></div>
            </div>
            
            <div style="margin-bottom: 1rem;">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">–î–∞—Ç–∞ —Å–ø–∏—Å–∞–Ω–∏—è:</label>
                <input type="date" id="writeoffDate" required style="width: 100%; padding: 8px 12px; border: 1px solid #ced4da; border-radius: 6px;">
            </div>
            
            <div style="margin-bottom: 1rem;">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">–ü—Ä–∏—á–∏–Ω–∞ —Å–ø–∏—Å–∞–Ω–∏—è:</label>
                <select id="writeoffReason" required style="width: 100%; padding: 8px 12px; border: 1px solid #ced4da; border-radius: 6px;">
                    <option value="–ë—Ä–∞–∫">–ë—Ä–∞–∫</option>
                    <option value="–ü–æ—Ä—á–∞">–ü–æ—Ä—á–∞</option>
                    <option value="–ò—Å—Ç–µ–∫ —Å—Ä–æ–∫">–ò—Å—Ç–µ–∫ —Å—Ä–æ–∫</option>
                    <option value="–ü–æ—Ç–µ—Ä—è">–ü–æ—Ç–µ—Ä—è</option>
                    <option value="–î—Ä—É–≥–æ–µ">–î—Ä—É–≥–æ–µ</option>
                </select>
            </div>
            
            <div style="margin-bottom: 1.5rem;">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:</label>
                <textarea id="writeoffNote" rows="3" placeholder="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è..." style="width: 100%; padding: 8px 12px; border: 1px solid #ced4da; border-radius: 6px;"></textarea>
            </div>
            
            <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                <button type="button" id="cancelWriteoff" class="btn btn-secondary">–û—Ç–º–µ–Ω–∞</button>
                <button type="submit" class="btn btn-danger">üóëÔ∏è –°–ø–∏—Å–∞—Ç—å —Ç–æ–≤–∞—Ä</button>
            </div>
        </form>
    </div>
</div>

<!-- History Modal -->
<div id="historyModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 2rem; border-radius: 8px; width: 800px; max-width: 90vw; height: 600px; overflow-y: auto;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
            <h3 style="color: #2c3e50;">üìã –ò—Å—Ç–æ—Ä–∏—è –¥–≤–∏–∂–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–æ–≤</h3>
            <button id="closeHistory" class="btn btn-secondary">‚úñ –ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
        
        <div id="historyContent" style="min-height: 400px;">
            <div style="text-align: center; padding: 2rem; color: #6c757d;">
                –ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏...
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const selectAll = document.getElementById('selectAll');
    const flowerCheckboxes = document.querySelectorAll('.flower-checkbox');
    const bulkUpdateBtn = document.getElementById('bulkUpdateBtn');
    
    // Select all functionality
    selectAll.addEventListener('change', function() {
        flowerCheckboxes.forEach(checkbox => {
            checkbox.checked = this.checked;
        });
        updateBulkButtonState();
    });
    
    // Individual checkbox listeners
    flowerCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', updateBulkButtonState);
    });
    
    function updateBulkButtonState() {
        const checkedCount = document.querySelectorAll('.flower-checkbox:checked').length;
        bulkUpdateBtn.disabled = checkedCount === 0;
        bulkUpdateBtn.textContent = checkedCount > 0 ? `üìä –û–±–Ω–æ–≤–∏—Ç—å (${checkedCount})` : 'üìä –ú–∞—Å—Å–æ–≤–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ';
    }
    
    // Single product update
    document.querySelectorAll('.update-single').forEach(button => {
        button.addEventListener('click', function() {
            const flowerId = this.dataset.flowerId;
            const quantityInput = document.querySelector(`.quantity-input[data-flower-id="${flowerId}"]`);
            const newQuantity = parseInt(quantityInput.value);
            
            updateFlowerQuantity(flowerId, newQuantity, this);
        });
    });
    
    // Bulk update
    bulkUpdateBtn.addEventListener('click', function() {
        const checkedBoxes = document.querySelectorAll('.product-checkbox:checked');
        const updates = [];
        
        checkedBoxes.forEach(checkbox => {
            const productId = checkbox.value;
            const quantityInput = document.querySelector(`.quantity-input[data-flower-id="${flowerId}"]`);
            const newQuantity = parseInt(quantityInput.value);
            
            updates.push({
                flower_id: flowerId,
                quantity: newQuantity,
                reason: 'Bulk update via inventory management'
            });
        });
        
        if (updates.length > 0) {
            bulkUpdateQuantities(updates);
        }
    });
    
    function updateFlowerQuantity(flowerId, quantity, buttonElement) {
        buttonElement.disabled = true;
        buttonElement.textContent = '‚è≥ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';
        
        fetch('/api/flowers/update-quantity', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                flower_id: flowerId,
                quantity: quantity,
                reason: 'Manual update via inventory management'
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Update current quantity display
                const currentSpan = buttonElement.closest('tr').querySelector('.quantity-current');
                currentSpan.textContent = quantity;
                currentSpan.className = 'quantity-current';
                currentSpan.style.cssText += `padding: 4px 12px; border-radius: 20px; font-weight: 600; ${
                    quantity === 0 ? 'background: #f8d7da; color: #721c24;' :
                    quantity <= 5 ? 'background: #fff3cd; color: #856404;' :
                    'background: #d4edda; color: #155724;'
                }`;
                
                buttonElement.textContent = '‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ';
                setTimeout(() => {
                    buttonElement.textContent = 'üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
                    buttonElement.disabled = false;
                }, 2000);
            } else {
                throw new Error(data.detail || 'Update failed');
            }
        })
        .catch(error => {
            console.error('Update error:', error);
            buttonElement.textContent = '‚ùå –û—à–∏–±–∫–∞';
            setTimeout(() => {
                buttonElement.textContent = 'üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
                buttonElement.disabled = false;
            }, 2000);
        });
    }
    
    function bulkUpdateQuantities(updates) {
        bulkUpdateBtn.disabled = true;
        bulkUpdateBtn.textContent = '‚è≥ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ...';
        
        fetch('/api/inventory/bulk-update', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                updates: updates
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Update display for all successful updates
                data.updated_products.forEach(product => {
                    const row = document.querySelector(`tr[data-product-id="${product.product_id}"]`);
                    if (row) {
                        const currentSpan = row.querySelector('.quantity-current');
                        currentSpan.textContent = product.new_quantity;
                        currentSpan.className = 'quantity-current';
                        currentSpan.style.cssText += `padding: 4px 12px; border-radius: 20px; font-weight: 600; ${
                            product.new_quantity === 0 ? 'background: #f8d7da; color: #721c24;' :
                            product.new_quantity <= 5 ? 'background: #fff3cd; color: #856404;' :
                            'background: #d4edda; color: #155724;'
                        }`;
                    }
                });
                
                bulkUpdateBtn.textContent = `‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–æ (${data.updated_count})`;
                
                // Clear selections
                selectAll.checked = false;
                productCheckboxes.forEach(checkbox => checkbox.checked = false);
                
                setTimeout(() => {
                    updateBulkButtonState();
                }, 3000);
            } else {
                throw new Error('Bulk update failed');
            }
        })
        .catch(error => {
            console.error('Bulk update error:', error);
            bulkUpdateBtn.textContent = '‚ùå –û—à–∏–±–∫–∞';
            setTimeout(() => {
                updateBulkButtonState();
            }, 2000);
        });
    }
    
    // Load flowers for modals
    async function loadFlowersForModals() {
        try {
            const response = await fetch('/api/flowers/search?q=');
            const flowers = await response.json();
            
            const deliverySelect = document.getElementById('deliveryFlowerSelect');
            const writeoffSelect = document.getElementById('writeoffFlowerSelect');
            
            // Clear existing options
            deliverySelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ü–≤–µ—Ç–æ–∫...</option>';
            writeoffSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ü–≤–µ—Ç–æ–∫...</option>';
            
            flowers.forEach(flower => {
                const option1 = document.createElement('option');
                option1.value = flower.id;
                option1.textContent = `${flower.name} (–æ—Å—Ç–∞—Ç–æ–∫: ${flower.quantity || 0})`;
                option1.dataset.quantity = flower.quantity || 0;
                deliverySelect.appendChild(option1);
                
                const option2 = document.createElement('option');
                option2.value = flower.id;
                option2.textContent = `${flower.name} (–æ—Å—Ç–∞—Ç–æ–∫: ${flower.quantity || 0})`;
                option2.dataset.quantity = flower.quantity || 0;
                writeoffSelect.appendChild(option2);
            });
        } catch (error) {
            console.error('Error loading flowers:', error);
        }
    }
    
    // Initialize modals
    const addDeliveryBtn = document.getElementById('addDeliveryBtn');
    const writeoffBtn = document.getElementById('writeoffBtn');
    const historyBtn = document.getElementById('historyBtn');
    
    const deliveryModal = document.getElementById('deliveryModal');
    const writeoffModal = document.getElementById('writeoffModal');
    const historyModal = document.getElementById('historyModal');
    
    const deliveryForm = document.getElementById('deliveryForm');
    const writeoffForm = document.getElementById('writeoffForm');
    
    // Set current date in ISO format "YYYY-MM-DD" 
    const currentDate = new Date().toISOString().split('T')[0];
    
    // Modal open/close handlers
    addDeliveryBtn.addEventListener('click', () => {
        loadFlowersForModals();
        document.getElementById('deliveryDate').value = currentDate;
        deliveryModal.style.display = 'block';
    });
    
    writeoffBtn.addEventListener('click', () => {
        loadFlowersForModals();
        document.getElementById('writeoffDate').value = currentDate;
        writeoffModal.style.display = 'block';
    });
    
    historyBtn.addEventListener('click', () => {
        loadInventoryHistory();
        historyModal.style.display = 'block';
    });
    
    // Close modal handlers
    document.getElementById('cancelDelivery').addEventListener('click', () => {
        deliveryModal.style.display = 'none';
    });
    
    document.getElementById('cancelWriteoff').addEventListener('click', () => {
        writeoffModal.style.display = 'none';
    });
    
    document.getElementById('closeHistory').addEventListener('click', () => {
        historyModal.style.display = 'none';
    });
    
    // Update available quantity display when product is selected for writeoff
    document.getElementById('writeoffFlowerSelect').addEventListener('change', (e) => {
        const availableDiv = document.getElementById('availableQuantity');
        if (e.target.value) {
            const quantity = e.target.selectedOptions[0].dataset.quantity;
            availableDiv.textContent = `–î–æ—Å—Ç—É–ø–Ω–æ –¥–ª—è —Å–ø–∏—Å–∞–Ω–∏—è: ${quantity} —à—Ç.`;
            document.getElementById('writeoffQuantity').max = quantity;
        } else {
            availableDiv.textContent = '';
            document.getElementById('writeoffQuantity').removeAttribute('max');
        }
    });
    
    // Delivery form submission
    deliveryForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const formData = {
            flower_id: document.getElementById('deliveryFlowerSelect').value,
            quantity: parseInt(document.getElementById('deliveryQuantity').value),
            delivery_date: document.getElementById('deliveryDate').value,
            note: document.getElementById('deliveryNote').value
        };
        
        try {
            const response = await fetch('/api/flowers/delivery', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(formData)
            });
            
            const result = await response.json();
            
            if (result.success) {
                alert(`‚úÖ ${result.message}`);
                deliveryModal.style.display = 'none';
                deliveryForm.reset();
                location.reload(); // Reload to see updated quantities
            } else {
                alert(`‚ùå –û—à–∏–±–∫–∞: ${result.detail || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}`);
            }
        } catch (error) {
            console.error('Delivery error:', error);
            alert('‚ùå –û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–æ—Å—Ç–∞–≤–∫–∏');
        }
    });
    
    // Writeoff form submission
    writeoffForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const formData = {
            flower_id: document.getElementById('writeoffFlowerSelect').value,
            quantity: parseInt(document.getElementById('writeoffQuantity').value),
            writeoff_date: document.getElementById('writeoffDate').value,
            reason: document.getElementById('writeoffReason').value,
            note: document.getElementById('writeoffNote').value
        };
        
        try {
            const response = await fetch('/api/flowers/writeoff', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(formData)
            });
            
            const result = await response.json();
            
            if (result.success) {
                alert(`‚úÖ ${result.message}`);
                writeoffModal.style.display = 'none';
                writeoffForm.reset();
                location.reload(); // Reload to see updated quantities
            } else {
                alert(`‚ùå –û—à–∏–±–∫–∞: ${result.detail || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}`);
            }
        } catch (error) {
            console.error('Writeoff error:', error);
            alert('‚ùå –û—à–∏–±–∫–∞ —Å–ø–∏—Å–∞–Ω–∏—è —Ç–æ–≤–∞—Ä–∞');
        }
    });
    
    // Load inventory history
    async function loadInventoryHistory() {
        try {
            const response = await fetch('/api/inventory/history?limit=100');
            const result = await response.json();
            
            const historyContent = document.getElementById('historyContent');
            
            if (result.success && result.movements.length > 0) {
                const historyHTML = `
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: #f8f9fa;">
                                <th style="padding: 12px; text-align: left; border-bottom: 2px solid #dee2e6;">–î–∞—Ç–∞</th>
                                <th style="padding: 12px; text-align: left; border-bottom: 2px solid #dee2e6;">–¢–æ–≤–∞—Ä</th>
                                <th style="padding: 12px; text-align: center; border-bottom: 2px solid #dee2e6;">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</th>
                                <th style="padding: 12px; text-align: left; border-bottom: 2px solid #dee2e6;">–û–ø–µ—Ä–∞—Ü–∏—è</th>
                                <th style="padding: 12px; text-align: left; border-bottom: 2px solid #dee2e6;">–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${result.movements.map(movement => `
                                <tr style="border-bottom: 1px solid #dee2e6;">
                                    <td style="padding: 8px 12px;">${movement.delivery_date || '-'}</td>
                                    <td style="padding: 8px 12px; font-weight: 600;">${movement.product_name}</td>
                                    <td style="padding: 8px 12px; text-align: center;">
                                        <span style="color: ${movement.quantity > 0 ? '#28a745' : '#dc3545'};">
                                            ${movement.quantity > 0 ? '+' : ''}${movement.quantity}
                                        </span>
                                    </td>
                                    <td style="padding: 8px 12px;">
                                        <span style="padding: 2px 8px; border-radius: 12px; font-size: 0.8rem; 
                                              background: ${movement.reason === 'delivery' ? '#d4edda' : '#f8d7da'}; 
                                              color: ${movement.reason === 'delivery' ? '#155724' : '#721c24'};">
                                            ${movement.reason === 'delivery' ? 'üì¶ –ü–æ—Å—Ç–∞–≤–∫–∞' : 'üóëÔ∏è –°–ø–∏—Å–∞–Ω–∏–µ'}
                                        </span>
                                    </td>
                                    <td style="padding: 8px 12px; font-size: 0.9rem; color: #6c757d;">${movement.note || '-'}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
                historyContent.innerHTML = historyHTML;
            } else {
                historyContent.innerHTML = `
                    <div style="text-align: center; padding: 3rem; color: #6c757d;">
                        üìã –ò—Å—Ç–æ—Ä–∏—è –¥–≤–∏–∂–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–æ–≤ –ø–æ–∫–∞ –ø—É—Å—Ç–∞
                    </div>
                `;
            }
        } catch (error) {
            console.error('History loading error:', error);
            document.getElementById('historyContent').innerHTML = `
                <div style="text-align: center; padding: 3rem; color: #dc3545;">
                    ‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏
                </div>
            `;
        }
    }
    
    // Close modals by clicking outside
    [deliveryModal, writeoffModal, historyModal].forEach(modal => {
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                modal.style.display = 'none';
            }
        });
    });
});
</script>
{% endblock %}