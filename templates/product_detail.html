{% extends "base.html" %}
{% block title %}{{ product.name }} - CRM{% endblock %}

{% block content %}
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
    <h2 style="color: #2c3e50;">
        üå∏ {{ product.name }}
    </h2>
    <a href="/crm/products" class="btn btn-secondary">‚Üê –ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É</a>
</div>

<div style="display: grid; grid-template-columns: 1fr 2fr; gap: 2rem; margin-bottom: 2rem;">
    
    <!-- Product Image -->
    <div class="card">
        <div class="card-header">
            <h3>üì∑ –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</h3>
        </div>
        <div class="card-body" style="text-align: center;">
            {% set image_url = product.get('metadata', {}).get('properties', {}).get('ru_img_miniature') %}
            {% if image_url %}
            <img src="https://cvety.kz{{ image_url }}" 
                 alt="{{ product.name }}" 
                 style="max-width: 100%; max-height: 400px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1);">
            {% else %}
            <div style="width: 100%; height: 300px; background: #f8f9fa; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: #6c757d; font-size: 3rem;">
                üå∏
            </div>
            <p style="color: #6c757d; margin-top: 1rem;">–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ</p>
            {% endif %}
        </div>
    </div>
    
    <!-- Product Information -->
    <div class="card">
        <div class="card-header">
            <h3>üìã –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç–æ–≤–∞—Ä–µ</h3>
        </div>
        <div class="card-body">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
                <div>
                    <strong>–¶–µ–Ω–∞:</strong><br>
                    {% if product.old_price and product.old_price > product.price %}
                    <span style="text-decoration: line-through; color: #6c757d; font-size: 0.9rem;">
                        {{ "%.0f"|format(product.old_price) }} ‚Ç∏
                    </span><br>
                    {% endif %}
                    <span style="font-size: 1.5rem; font-weight: bold; color: #27ae60;">
                        {{ "%.0f"|format(product.price) }} ‚Ç∏
                    </span>
                </div>
                <div>
                    <strong>–°—Ç–∞—Ç—É—Å:</strong><br>
                    {% if product.is_active %}
                    <span class="status" style="background: #d4edda; color: #155724;">‚úÖ –ê–∫—Ç–∏–≤–µ–Ω</span>
                    {% else %}
                    <span class="status" style="background: #f8d7da; color: #721c24;">‚ùå –ù–µ–∞–∫—Ç–∏–≤–µ–Ω</span>
                    {% endif %}
                </div>
                <div>
                    <strong>ID —Ç–æ–≤–∞—Ä–∞:</strong><br>
                    <small style="font-family: monospace; background: #f8f9fa; padding: 4px 8px; border-radius: 4px;">
                        {{ product.id }}
                    </small>
                </div>
                {% if product.sku %}
                <div>
                    <strong>–ê—Ä—Ç–∏–∫—É–ª:</strong><br>
                    <span style="font-family: monospace; background: #e3f2fd; padding: 4px 8px; border-radius: 4px;">
                        {{ product.sku }}
                    </span>
                </div>
                {% endif %}
                {% if product.slug %}
                <div>
                    <strong>URL-—Å–ª–∞–≥:</strong><br>
                    <span style="font-family: monospace; color: #6c757d;">
                        {{ product.slug }}
                    </span>
                </div>
                {% endif %}
                {% if product.category_id %}
                <div>
                    <strong>ID –∫–∞—Ç–µ–≥–æ—Ä–∏–∏:</strong><br>
                    <span style="color: #6c757d;">{{ product.category_id }}</span>
                </div>
                {% endif %}
                {% if seller %}
                <div>
                    <strong>–ü–æ—Å—Ç–∞–≤—â–∏–∫:</strong><br>
                    {{ seller.name or seller.id }}
                </div>
                {% elif product.seller_id %}
                <div>
                    <strong>ID –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞:</strong><br>
                    <span style="color: #6c757d;">{{ product.seller_id }}</span>
                </div>
                {% endif %}
                {% if product.created_at %}
                <div>
                    <strong>–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:</strong><br>
                    {{ product.created_at[:16].replace('T', ' ') }}
                </div>
                {% endif %}
                {% if product.updated_at %}
                <div>
                    <strong>–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ:</strong><br>
                    {{ product.updated_at[:16].replace('T', ' ') }}
                </div>
                {% endif %}
            </div>
            
            {% if composition %}
            <div style="margin-top: 1.5rem; padding: 1rem; background: #e8f5e9; border-radius: 6px;">
                <strong>üå∏ –°–æ—Å—Ç–∞–≤ –±—É–∫–µ—Ç–∞:</strong><br>
                <div style="margin-top: 0.5rem; line-height: 1.8;">
                    {% for item in composition %}
                    <div style="padding: 3px 0; font-size: 1.1rem;">
                        ‚Ä¢ {{ item.amount }} √ó {{ item.flower_name }}
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% elif product.composition %}
            <div style="margin-top: 1.5rem; padding: 1rem; background: #e8f5e9; border-radius: 6px;">
                <strong>üå∏ –°–æ—Å—Ç–∞–≤ –±—É–∫–µ—Ç–∞:</strong><br>
                <div style="margin-top: 0.5rem; line-height: 1.5; font-size: 1.1rem;">
                    {{ product.composition }}
                </div>
            </div>
            {% endif %}
            
            {% if product.description %}
            <div style="margin-top: 1.5rem; padding: 1rem; background: #f8f9fa; border-radius: 6px;">
                <strong>üìù –û–ø–∏—Å–∞–Ω–∏–µ:</strong><br>
                <div style="margin-top: 0.5rem; line-height: 1.5;">
                    {{ product.description }}
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Metadata and Technical Info -->
{% if product.metadata %}
<div class="card">
    <div class="card-header">
        <h3>üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h3>
    </div>
    <div class="card-body">
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem;">
            {% if product.metadata.get('properties') %}
            <div>
                <strong>üìã –°–≤–æ–π—Å—Ç–≤–∞ —Ç–æ–≤–∞—Ä–∞:</strong>
                <div style="margin-top: 0.5rem; background: #f8f9fa; padding: 0.75rem; border-radius: 4px; font-family: monospace; font-size: 0.85rem; max-height: 200px; overflow-y: auto;">
                    {% for key, value in product.metadata.properties.items() %}
                    <div><strong>{{ key }}:</strong> {{ value }}</div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
            
            {% if product.attributes %}
            <div>
                <strong>üè∑Ô∏è –ê—Ç—Ä–∏–±—É—Ç—ã:</strong>
                <div style="margin-top: 0.5rem; background: #e3f2fd; padding: 0.75rem; border-radius: 4px; font-family: monospace; font-size: 0.85rem; max-height: 200px; overflow-y: auto;">
                    {% for key, value in product.attributes.items() %}
                    <div><strong>{{ key }}:</strong> {{ value }}</div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
            
            <div>
                <strong>‚öôÔ∏è –ü–æ–ª–Ω—ã–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ:</strong>
                <div style="margin-top: 0.5rem; background: #fff3cd; padding: 0.75rem; border-radius: 4px; font-family: monospace; font-size: 0.75rem; max-height: 300px; overflow-y: auto; white-space: pre-wrap;">{{ product.metadata | tojson(indent=2) }}</div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Action Buttons -->
<div style="margin-top: 2rem;">
    <!-- Availability Management -->
    <div style="text-align: center; margin-bottom: 1rem;">
        <h4 style="color: #2c3e50; margin-bottom: 1rem;">üîÑ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞–ª–∏—á–∏–µ–º</h4>
        {% set in_stock = product.get('metadata', {}).get('properties', {}).get('IN_STOCK') %}
        <div id="availability-status-{{ product.id }}" style="margin-bottom: 1rem;">
            {% if in_stock == '158' %}
            <span class="status" style="background: #d1ecf1; color: #0c5460; padding: 0.5rem 1rem; border-radius: 4px; font-size: 1.2rem;">üì¶ –í –Ω–∞–ª–∏—á–∏–∏</span>
            {% elif in_stock == '159' %}
            <span class="status" style="background: #f8d7da; color: #721c24; padding: 0.5rem 1rem; border-radius: 4px; font-size: 1.2rem;">‚ö†Ô∏è –ù–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏</span>
            {% else %}
            <span class="status" style="background: #fff3cd; color: #856404; padding: 0.5rem 1rem; border-radius: 4px; font-size: 1.2rem;">‚ùì –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ</span>
            {% endif %}
        </div>
        <div>
            {% if in_stock == '158' %}
            <button id="availability-toggle-{{ product.id }}" class="btn btn-warning" onclick="toggleProductAvailability('{{ product.id }}', false)" style="margin-right: 0.5rem;">
                üì¶‚û°Ô∏è‚ö†Ô∏è –°–¥–µ–ª–∞—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã–º
            </button>
            {% else %}
            <button id="availability-toggle-{{ product.id }}" class="btn btn-info" onclick="toggleProductAvailability('{{ product.id }}', true)" style="margin-right: 0.5rem;">
                ‚ö†Ô∏è‚û°Ô∏èüì¶ –°–¥–µ–ª–∞—Ç—å –¥–æ—Å—Ç—É–ø–Ω—ã–º
            </button>
            {% endif %}
        </div>
    </div>
    
    <!-- Site Link -->
    <div style="text-align: center; margin-bottom: 1rem;">
        {% set ru_url = product.get('metadata', {}).get('properties', {}).get('ru_url') %}
        {% if ru_url %}
        <a href="https://cvety.kz/products/{{ ru_url }}/" 
           target="_blank" 
           rel="noopener noreferrer"
           class="btn btn-success"
           style="margin-right: 0.5rem;"
           title="–û—Ç–∫—Ä—ã—Ç—å —Ç–æ–≤–∞—Ä –Ω–∞ —Å–∞–π—Ç–µ">
            üîó –ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å –Ω–∞ —Å–∞–π—Ç–µ
        </a>
        {% endif %}
    </div>
    
    <!-- Edit and Navigation Buttons -->
    <div style="text-align: center;">
        <a href="/crm/products/{{ product.id }}/edit" class="btn btn-primary" style="margin-right: 0.5rem;">
            ‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–≤–∞—Ä
        </a>
        <a href="/crm/products" class="btn btn-secondary">
            ‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ —Å–ø–∏—Å–∫—É —Ç–æ–≤–∞—Ä–æ–≤
        </a>
    </div>
</div>

<script>
async function toggleProductAvailability(productId, makeAvailable) {
    try {
        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º action –∏ —Ç–µ–∫—Å—Ç
        const action = makeAvailable ? 'set-available' : 'set-unavailable';
        const actionText = makeAvailable ? '—Å–¥–µ–ª–∞—Ç—å –¥–æ—Å—Ç—É–ø–Ω—ã–º' : '—Å–¥–µ–ª–∞—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã–º';
        
        // –ù–∞—Ö–æ–¥–∏–º –∫–Ω–æ–ø–∫—É –∏ –±–ª–æ–∫–∏—Ä—É–µ–º –µ—ë
        const button = document.getElementById(`availability-toggle-${productId}`);
        const statusDiv = document.getElementById(`availability-status-${productId}`);
        const originalButtonHtml = button.innerHTML;
        
        button.disabled = true;
        button.innerHTML = '‚è≥ –û–±—Ä–∞–±–æ—Ç–∫–∞...';
        
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –∫ API
        const response = await fetch(`/api/products/${productId}/${action}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        if (response.ok) {
            const result = await response.json();
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—Ö–µ
            console.log(`‚úÖ ${result.message}`);
            alert(`‚úÖ ${result.message}`);
            
            // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É –¥–ª—è –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
            setTimeout(() => {
                window.location.reload();
            }, 1000); // –î–∞–µ–º –≤—Ä–µ–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é —É–≤–∏–¥–µ—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
            
        } else {
            const error = await response.text();
            alert(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ ${actionText} —Ç–æ–≤–∞—Ä:\n${error}`);
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
            button.innerHTML = originalButtonHtml;
        }
        
    } catch (error) {
        console.error('Error toggling product availability:', error);
        alert(`–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ${error.message}`);
        
        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
        const button = document.getElementById(`availability-toggle-${productId}`);
        if (button) {
            button.disabled = false;
            button.innerHTML = makeAvailable ? '‚ö†Ô∏è‚û°Ô∏èüì¶ –°–¥–µ–ª–∞—Ç—å –¥–æ—Å—Ç—É–ø–Ω—ã–º' : 'üì¶‚û°Ô∏è‚ö†Ô∏è –°–¥–µ–ª–∞—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã–º';
        }
    } finally {
        // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É
        const button = document.getElementById(`availability-toggle-${productId}`);
        if (button) {
            button.disabled = false;
        }
    }
}
</script>

{% endblock %}