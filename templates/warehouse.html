{% extends "base.html" %}

{% block title %}–°–∫–ª–∞–¥ - CRM System{% endblock %}

{% block content %}
<div class="filters">
    <h2 style="margin-bottom: 1rem;">üè™ –°–∫–ª–∞–¥ —Ü–≤–µ—Ç–æ–≤</h2>
    
    <form method="GET" action="/crm/warehouse">
        <input type="text" 
               name="search" 
               value="{{ search }}" 
               placeholder="üîç –ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é —Ü–≤–µ—Ç–∫–∞..." 
               style="width: 300px;">
        <button type="submit" class="btn btn-primary">–ù–∞–π—Ç–∏</button>
        {% if search %}
        <a href="/crm/warehouse" class="btn btn-secondary">–û—á–∏—Å—Ç–∏—Ç—å</a>
        {% endif %}
    </form>
</div>

<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-number">{{ total_flowers }}</div>
        <div class="stat-label">–í—Å–µ–≥–æ –≤–∏–¥–æ–≤ —Ü–≤–µ—Ç–æ–≤</div>
    </div>
    
    <div class="stat-card">
        <div class="stat-number">{{ warehouse_stats|length }}</div>
        <div class="stat-label">
            {% if search %}
                –ù–∞–π–¥–µ–Ω–æ (–ø–æ–∏—Å–∫: "{{ search }}")
            {% else %}
                –ü–æ–∫–∞–∑–∞–Ω–æ
            {% endif %}
        </div>
    </div>
    
    <div class="stat-card">
        <div class="stat-number">
            {% set total_usage = 0 %}
            {% for item in warehouse_stats %}
                {% set total_usage = total_usage + item.total_used %}
            {% endfor %}
            {{ total_usage }}
        </div>
        <div class="stat-label">–í—Å–µ–≥–æ —Ü–≤–µ—Ç–æ–≤ –≤ —Å–æ—Å—Ç–∞–≤–∞—Ö</div>
    </div>
    
    <div class="stat-card">
        <div class="stat-number">
            {% set active_flowers = 0 %}
            {% for item in warehouse_stats %}
                {% if item.products_count > 0 %}
                    {% set active_flowers = active_flowers + 1 %}
                {% endif %}
            {% endfor %}
            {{ active_flowers }}
        </div>
        <div class="stat-label">–ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –≤ –±—É–∫–µ—Ç–∞—Ö</div>
    </div>
</div>

<div class="card">
    <div class="card-header">
        <h3>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Ü–≤–µ—Ç–æ–≤</h3>
        <p style="color: #6c757d; font-size: 0.9rem; margin-top: 0.5rem;">
            –û—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ –±—É–∫–µ—Ç–∞—Ö
        </p>
    </div>
    
    <div class="card-body" style="padding: 0;">
        {% if warehouse_stats %}
        <table>
            <thead>
                <tr>
                    <th>–ù–∞–∑–≤–∞–Ω–∏–µ —Ü–≤–µ—Ç–∫–∞</th>
                    <th style="width: 8rem;">XML ID</th>
                    <th style="width: 7rem;">–í—Å–µ–≥–æ –≤ —Å–æ—Å—Ç–∞–≤–∞—Ö</th>
                    <th style="width: 7rem;">–í –±—É–∫–µ—Ç–∞—Ö</th>
                    <th style="width: 10rem;">–°—Ç–∞—Ç—É—Å</th>
                </tr>
            </thead>
            <tbody>
                {% for item in warehouse_stats %}
                <tr>
                    <td>
                        <a href="/crm/warehouse/{{ item.flower.id }}" 
                           style="text-decoration: none; color: inherit;">
                            <strong style="color: #4CAF50; text-decoration: underline;">{{ item.flower.name }}</strong>
                        </a>
                        {% if item.flower.color %}
                        <br>
                        <small style="color: #6c757d;">–¶–≤–µ—Ç: {{ item.flower.color }}</small>
                        {% endif %}
                    </td>
                    <td>
                        <code style="font-size: 0.8rem; background: #f8f9fa; padding: 2px 6px; border-radius: 4px;">
                            {{ item.flower.xml_id }}
                        </code>
                    </td>
                    <td style="text-align: center;">
                        {% if item.total_used > 0 %}
                        <span style="font-size: 1.2rem; font-weight: 600; color: #27ae60;">
                            {{ item.total_used }}
                        </span>
                        {% else %}
                        <span style="color: #6c757d;">0</span>
                        {% endif %}
                    </td>
                    <td style="text-align: center;">
                        {% if item.products_count > 0 %}
                        <span style="font-size: 1.1rem; font-weight: 500; color: #3498db;">
                            {{ item.products_count }}
                        </span>
                        {% else %}
                        <span style="color: #6c757d;">0</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if item.total_used > 100 %}
                        <span class="status status-completed">–ü–æ–ø—É–ª—è—Ä–Ω—ã–π</span>
                        {% elif item.total_used > 20 %}
                        <span class="status status-processing">–ê–∫—Ç–∏–≤–Ω—ã–π</span>
                        {% elif item.total_used > 0 %}
                        <span class="status status-new">–†–µ–¥–∫–∏–π</span>
                        {% else %}
                        <span class="status status-cancelled">–ù–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <div style="text-align: center; padding: 3rem; color: #6c757d;">
            {% if search %}
            <h4>üîç –ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</h4>
            <p>–ü–æ –∑–∞–ø—Ä–æ—Å—É "{{ search }}" —Ü–≤–µ—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.</p>
            <a href="/crm/warehouse" class="btn btn-primary">–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ —Ü–≤–µ—Ç—ã</a>
            {% else %}
            <h4>üå∏ –¶–≤–µ—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</h4>
            <p>–í —Å–∫–ª–∞–¥–µ –ø–æ–∫–∞ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ —Ü–≤–µ—Ç–∞—Ö.</p>
            {% endif %}
        </div>
        {% endif %}
    </div>
</div>

{% if warehouse_stats %}
<div style="margin-top: 2rem; text-align: center; color: #6c757d; font-size: 0.9rem;">
    <p>
        üí° <strong>–°–æ–≤–µ—Ç:</strong> –¶–≤–µ—Ç—ã —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º "–ü–æ–ø—É–ª—è—Ä–Ω—ã–π" –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è —á–∞—â–µ –≤—Å–µ–≥–æ –≤ –±—É–∫–µ—Ç–∞—Ö. 
        –¶–≤–µ—Ç—ã —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º "–ù–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è" –º–æ–∂–Ω–æ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –∏–∑ —Å–ª–æ–≤–∞—Ä—è.
    </p>
</div>
{% endif %}

<style>
    .card-body table {
        margin: 0;
    }
    
    .card-body tr:hover {
        background: #f8f9fa;
    }
    
    code {
        font-size: 0.8rem;
        background: #f8f9fa;
        padding: 2px 6px;
        border-radius: 4px;
        border: 1px solid #e9ecef;
    }
    
    .status {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 0.7rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
</style>
{% endblock %}