{% extends "base.html" %}
{% block title %}–¢–æ–≤–∞—Ä—ã - CRM{% endblock %}

{% block content %}
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
    <h2 style="color: #2c3e50;">üå∏ –¢–æ–≤–∞—Ä—ã ({{ total }})</h2>
    <a href="/crm/products/new" class="btn btn-success">‚ûï –°–æ–∑–¥–∞—Ç—å —Ç–æ–≤–∞—Ä</a>
</div>

<div class="filters">
    <form method="get">
        <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
            <select name="seller_id" 
                    style="min-width: 250px; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;"
                    onchange="this.form.submit()">
                <option value="">üè™ –í—Å–µ –º–∞–≥–∞–∑–∏–Ω—ã ({{ total }} —Ç–æ–≤–∞—Ä–æ–≤)</option>
                {% for seller in sellers %}
                <option value="{{ seller.id }}" 
                        {% if selected_seller_id == seller.id %}selected{% endif %}>
                    {{ seller.name }} ({{ seller.product_count }} —Ç–æ–≤–∞—Ä–æ–≤)
                </option>
                {% endfor %}
            </select>
            
            <input type="text" 
                   name="search" 
                   placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é —Ç–æ–≤–∞—Ä–∞" 
                   value="{{ search_term or '' }}"
                   style="min-width: 300px;">
            
            <button type="submit" class="btn btn-primary">üîç –ù–∞–π—Ç–∏</button>
            
            {% if search_term or selected_seller_id %}
            <a href="/crm/products" class="btn btn-secondary">‚úñ –°–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ —Ñ–∏–ª—å—Ç—Ä—ã</a>
            {% endif %}
        </div>
    </form>
</div>

{% if products %}
<div class="card">
    <div style="overflow-x: auto;">
        <table>
            <thead>
                <tr>
                    <th style="width: 80px;">–§–æ—Ç–æ</th>
                    <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                    <th>–ú–∞–≥–∞–∑–∏–Ω</th>
                    <th>–¶–µ–Ω–∞</th>
                    <th>–°—Ç–∞—Ç—É—Å</th>
                    <th>–ù–∞–ª–∏—á–∏–µ</th>
                    <th>–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è</th>
                    <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                </tr>
            </thead>
            <tbody>
                {% for product in products %}
                <tr {% if not product.is_active %}style="opacity: 0.6;"{% endif %}>
                    <td style="padding: 8px;">
                        {% set image_url = product.get('metadata', {}).get('properties', {}).get('ru_img_miniature') %}
                        {% if image_url %}
                        <img src="https://cvety.kz{{ image_url }}" 
                             alt="{{ product.name }}" 
                             style="width: 60px; height: 60px; object-fit: cover; border-radius: 6px;">
                        {% else %}
                        <div style="width: 60px; height: 60px; background: #f8f9fa; border-radius: 6px; display: flex; align-items: center; justify-content: center; color: #6c757d; font-size: 14px;">
                            üå∏
                        </div>
                        {% endif %}
                    </td>
                    <td>
                        <strong>{{ product.name }}</strong>
                        {% if product.description and product.description|length > 100 %}
                        <br><small style="color: #6c757d;">{{ product.description[:100] }}...</small>
                        {% elif product.description %}
                        <br><small style="color: #6c757d;">{{ product.description }}</small>
                        {% endif %}
                        {% if product.slug %}
                        <br><small style="color: #6c757d;">Slug: {{ product.slug }}</small>
                        {% endif %}
                    </td>
                    <td>
                        {% if product.seller_name %}
                        <span style="color: #6c757d; font-size: 0.9em;">{{ product.seller_name }}</span>
                        {% else %}
                        <span style="color: #999; font-style: italic;">‚Äî</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if product.old_price and product.old_price > product.price %}
                        <span style="text-decoration: line-through; color: #6c757d;">
                            {{ "%.0f"|format(product.old_price) }} ‚Ç∏
                        </span><br>
                        {% endif %}
                        <strong style="color: #27ae60;">{{ "%.0f"|format(product.price) }} ‚Ç∏</strong>
                    </td>
                    <td>
                        <div id="status-{{ product.id }}">
                            {% if product.is_active %}
                            <span class="status" style="background: #d4edda; color: #155724;">‚úÖ –ê–∫—Ç–∏–≤–µ–Ω</span>
                            {% else %}
                            <span class="status" style="background: #f8d7da; color: #721c24;">‚ùå –ù–µ–∞–∫—Ç–∏–≤–µ–Ω</span>
                            {% endif %}
                        </div>
                    </td>
                    <td>
                        <div id="availability-{{ product.id }}">
                            {% set in_stock = product.get('metadata', {}).get('properties', {}).get('IN_STOCK') %}
                            {% if in_stock == '158' %}
                            <span class="status" style="background: #d1ecf1; color: #0c5460;">üì¶ –í –Ω–∞–ª–∏—á–∏–∏</span>
                            {% elif in_stock == '159' %}
                            <span class="status" style="background: #f8d7da; color: #721c24;">‚ö†Ô∏è –ù–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏</span>
                            {% else %}
                            <span class="status" style="background: #e2e3e5; color: #6c757d;">‚ùì –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ</span>
                            {% endif %}
                        </div>
                    </td>
                    <td>
                        {% if product.created_at %}
                        {{ product.created_at[:10] }}
                        {% else %}
                        -
                        {% endif %}
                    </td>
                    <td>
                        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                            <a href="/crm/products/{{ product.id }}" class="btn btn-primary">
                                üëÅ –ü—Ä–æ—Å–º–æ—Ç—Ä
                            </a>
                            {% set ru_url = product.get('metadata', {}).get('properties', {}).get('ru_url') %}
                            {% if ru_url %}
                            <a href="https://cvety.kz/products/{{ ru_url }}/" 
                               target="_blank" 
                               rel="noopener noreferrer"
                               class="btn btn-info"
                               title="–û—Ç–∫—Ä—ã—Ç—å —Ç–æ–≤–∞—Ä –Ω–∞ —Å–∞–π—Ç–µ">
                                üîó –ù–∞ —Å–∞–π—Ç–µ
                            </a>
                            {% endif %}
                            <a href="/crm/products/{{ product.id }}/edit" class="btn btn-secondary">
                                ‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
                            </a>
                            <button id="toggle-{{ product.id }}"
                                    onclick="toggleProductStatus('{{ product.id }}', {{ 'false' if product.is_active else 'true' }})" 
                                    class="btn {% if product.is_active %}btn-warning{% else %}btn-success{% endif %}">
                                {% if product.is_active %}
                                ‚è∏Ô∏è –î–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å
                                {% else %}
                                ‚ñ∂Ô∏è –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å
                                {% endif %}
                            </button>
                            {% set in_stock = product.get('metadata', {}).get('properties', {}).get('IN_STOCK') %}
                            {% if in_stock == '158' %}
                            <button id="availability-toggle-{{ product.id }}"
                                    onclick="toggleProductAvailability('{{ product.id }}', false)" 
                                    class="btn btn-warning">
                                üì¶‚û°Ô∏è‚ö†Ô∏è –°–¥–µ–ª–∞—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã–º
                            </button>
                            {% elif in_stock == '159' %}
                            <button id="availability-toggle-{{ product.id }}"
                                    onclick="toggleProductAvailability('{{ product.id }}', true)" 
                                    class="btn btn-info">
                                ‚ö†Ô∏è‚û°Ô∏èüì¶ –°–¥–µ–ª–∞—Ç—å –¥–æ—Å—Ç—É–ø–Ω—ã–º
                            </button>
                            {% else %}
                            <button id="availability-toggle-{{ product.id }}"
                                    onclick="toggleProductAvailability('{{ product.id }}', true)" 
                                    class="btn btn-info">
                                ‚ùì‚û°Ô∏èüì¶ –°–¥–µ–ª–∞—Ç—å –¥–æ—Å—Ç—É–ø–Ω—ã–º
                            </button>
                            {% endif %}
                            <button onclick="deleteProduct('{{ product.id }}', '{{ product.name }}')" 
                                    class="btn btn-danger">
                                üóëÔ∏è –£–¥–∞–ª–∏—Ç—å
                            </button>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Pagination -->
{% if total_pages > 1 %}
<div class="pagination">
    {% if page > 1 %}
        <a href="?page={{ page - 1 }}{% if search_term %}&search={{ search_term }}{% endif %}{% if selected_seller_id %}&seller_id={{ selected_seller_id }}{% endif %}">
            ‚Üê –ù–∞–∑–∞–¥
        </a>
    {% endif %}
    
    {% for p in range(1, total_pages + 1) %}
        {% if p == page %}
            <span class="current">{{ p }}</span>
        {% elif p <= 3 or p >= total_pages - 2 or (p >= page - 2 and p <= page + 2) %}
            <a href="?page={{ p }}{% if search_term %}&search={{ search_term }}{% endif %}{% if selected_seller_id %}&seller_id={{ selected_seller_id }}{% endif %}">
                {{ p }}
            </a>
        {% elif p == page - 3 or p == page + 3 %}
            <span>...</span>
        {% endif %}
    {% endfor %}
    
    {% if page < total_pages %}
        <a href="?page={{ page + 1 }}{% if search_term %}&search={{ search_term }}{% endif %}{% if selected_seller_id %}&seller_id={{ selected_seller_id }}{% endif %}">
            –í–ø–µ—Ä—ë–¥ ‚Üí
        </a>
    {% endif %}
</div>
{% endif %}

{% else %}
<div class="card">
    <div class="card-body" style="text-align: center; padding: 4rem 2rem;">
        <h3 style="color: #6c757d; margin-bottom: 1rem;">üå∏ –¢–æ–≤–∞—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</h3>
        {% if search_term %}
        <p style="color: #6c757d;">–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –ø–æ–∏—Å–∫–æ–≤–æ–π –∑–∞–ø—Ä–æ—Å</p>
        <a href="/crm/products" class="btn btn-primary" style="margin-top: 1rem;">
            –ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ —Ç–æ–≤–∞—Ä—ã
        </a>
        {% else %}
        <p style="color: #6c757d;">–í —Å–∏—Å—Ç–µ–º–µ –ø–æ–∫–∞ –Ω–µ—Ç —Ç–æ–≤–∞—Ä–æ–≤</p>
        {% endif %}
    </div>
</div>
{% endif %}

<script>
async function toggleProductStatus(productId, activate) {
    try {
        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º action –∏ —Ç–µ–∫—Å—Ç
        const action = activate ? 'activate' : 'deactivate';
        const actionText = activate ? '–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å' : '–¥–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å';
        
        // –ù–∞—Ö–æ–¥–∏–º –∫–Ω–æ–ø–∫—É –∏ –±–ª–æ–∫–∏—Ä—É–µ–º –µ—ë
        const button = document.getElementById(`toggle-${productId}`);
        const statusDiv = document.getElementById(`status-${productId}`);
        const originalButtonHtml = button.innerHTML;
        
        button.disabled = true;
        button.innerHTML = '‚è≥ –û–±—Ä–∞–±–æ—Ç–∫–∞...';
        
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –∫ API
        const response = await fetch(`/api/products/${productId}/${action}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        if (response.ok) {
            const result = await response.json();
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
            if (result.is_active) {
                statusDiv.innerHTML = '<span class="status" style="background: #d4edda; color: #155724;">‚úÖ –ê–∫—Ç–∏–≤–µ–Ω</span>';
                button.className = 'btn btn-warning';
                button.innerHTML = '‚è∏Ô∏è –î–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å';
                button.setAttribute('onclick', `toggleProductStatus('${productId}', false)`);
            } else {
                statusDiv.innerHTML = '<span class="status" style="background: #f8d7da; color: #721c24;">‚ùå –ù–µ–∞–∫—Ç–∏–≤–µ–Ω</span>';
                button.className = 'btn btn-success';
                button.innerHTML = '‚ñ∂Ô∏è –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å';
                button.setAttribute('onclick', `toggleProductStatus('${productId}', true)`);
            }
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—Ö–µ
            console.log(`‚úÖ –¢–æ–≤–∞—Ä —É—Å–ø–µ—à–Ω–æ ${activate ? '–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω' : '–¥–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω'}`);
            
        } else {
            const error = await response.text();
            alert(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ ${actionText} —Ç–æ–≤–∞—Ä:\n${error}`);
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
            button.innerHTML = originalButtonHtml;
        }
        
    } catch (error) {
        console.error('Error toggling product status:', error);
        alert(`–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ${error.message}`);
        
        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
        const button = document.getElementById(`toggle-${productId}`);
        if (button) {
            button.disabled = false;
            button.innerHTML = activate ? '‚ñ∂Ô∏è –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å' : '‚è∏Ô∏è –î–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å';
        }
    } finally {
        // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É
        const button = document.getElementById(`toggle-${productId}`);
        if (button) {
            button.disabled = false;
        }
    }
}

async function toggleProductAvailability(productId, makeAvailable) {
    try {
        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º action –∏ —Ç–µ–∫—Å—Ç
        const action = makeAvailable ? 'set-available' : 'set-unavailable';
        const actionText = makeAvailable ? '—Å–¥–µ–ª–∞—Ç—å –¥–æ—Å—Ç—É–ø–Ω—ã–º' : '—Å–¥–µ–ª–∞—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã–º';
        
        // –ù–∞—Ö–æ–¥–∏–º –∫–Ω–æ–ø–∫—É –∏ –±–ª–æ–∫–∏—Ä—É–µ–º –µ—ë
        const button = document.getElementById(`availability-toggle-${productId}`);
        const availabilityDiv = document.getElementById(`availability-${productId}`);
        const originalButtonHtml = button.innerHTML;
        
        button.disabled = true;
        button.innerHTML = '‚è≥ –û–±—Ä–∞–±–æ—Ç–∫–∞...';
        
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –∫ API
        const response = await fetch(`/api/products/${productId}/${action}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        if (response.ok) {
            const result = await response.json();
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –Ω–∞–ª–∏—á–∏–µ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
            if (result.is_available) {
                availabilityDiv.innerHTML = '<span class="status" style="background: #d1ecf1; color: #0c5460;">üì¶ –í –Ω–∞–ª–∏—á–∏–∏</span>';
                button.className = 'btn btn-warning';
                button.innerHTML = 'üì¶‚û°Ô∏è‚ö†Ô∏è –°–¥–µ–ª–∞—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã–º';
                button.setAttribute('onclick', `toggleProductAvailability('${productId}', false)`);
            } else {
                availabilityDiv.innerHTML = '<span class="status" style="background: #f8d7da; color: #721c24;">‚ö†Ô∏è –ù–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏</span>';
                button.className = 'btn btn-info';
                button.innerHTML = '‚ö†Ô∏è‚û°Ô∏èüì¶ –°–¥–µ–ª–∞—Ç—å –¥–æ—Å—Ç—É–ø–Ω—ã–º';
                button.setAttribute('onclick', `toggleProductAvailability('${productId}', true)`);
            }
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—Ö–µ
            console.log(`‚úÖ ${result.message}`);
            alert(`‚úÖ ${result.message}`);
            
            // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É –¥–ª—è –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
            setTimeout(() => {
                window.location.reload();
            }, 1000); // –î–∞–µ–º –≤—Ä–µ–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é —É–≤–∏–¥–µ—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
            
        } else {
            const error = await response.text();
            alert(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ ${actionText} —Ç–æ–≤–∞—Ä:\n${error}`);
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
            button.innerHTML = originalButtonHtml;
        }
        
    } catch (error) {
        console.error('Error toggling product availability:', error);
        alert(`–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ${error.message}`);
        
        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
        const button = document.getElementById(`availability-toggle-${productId}`);
        if (button) {
            button.disabled = false;
            button.innerHTML = makeAvailable ? '‚ö†Ô∏è‚û°Ô∏èüì¶ –°–¥–µ–ª–∞—Ç—å –¥–æ—Å—Ç—É–ø–Ω—ã–º' : 'üì¶‚û°Ô∏è‚ö†Ô∏è –°–¥–µ–ª–∞—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã–º';
        }
    } finally {
        // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É
        const button = document.getElementById(`availability-toggle-${productId}`);
        if (button) {
            button.disabled = false;
        }
    }
}

async function deleteProduct(productId, productName) {
    // Show confirmation dialog
    if (!confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —Ç–æ–≤–∞—Ä "${productName}"?\n\n–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.`)) {
        return;
    }
    
    try {
        // Disable all delete buttons during the operation
        const deleteButtons = document.querySelectorAll('button[onclick*="deleteProduct"]');
        deleteButtons.forEach(btn => {
            btn.disabled = true;
            btn.innerHTML = '‚è≥ –£–¥–∞–ª–µ–Ω–∏–µ...';
        });
        
        // Make DELETE request to API
        const response = await fetch(`/api/products/${productId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        if (response.ok) {
            const result = await response.json();
            
            // Show success message
            alert(`‚úÖ ${result.message}`);
            
            // Reload the page to update the product list
            window.location.reload();
        } else {
            const error = await response.json();
            alert(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Ç–æ–≤–∞—Ä–∞: ${error.detail || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}`);
            
            // Re-enable buttons on error
            deleteButtons.forEach(btn => {
                btn.disabled = false;
                btn.innerHTML = 'üóëÔ∏è –£–¥–∞–ª–∏—Ç—å';
            });
        }
        
    } catch (error) {
        console.error('Delete error:', error);
        alert(`‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Ç–æ–≤–∞—Ä–∞: ${error.message}`);
        
        // Re-enable buttons on error
        const deleteButtons = document.querySelectorAll('button[onclick*="deleteProduct"]');
        deleteButtons.forEach(btn => {
            btn.disabled = false;
            btn.innerHTML = 'üóëÔ∏è –£–¥–∞–ª–∏—Ç—å';
        });
    }
}
</script>
{% endblock %}