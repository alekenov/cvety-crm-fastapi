# üîÑ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Webhook –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ Bitrix ‚Üî Python CRM

## üìã –ß—Ç–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ

### ‚úÖ –ì–æ—Ç–æ–≤—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:

1. **Webhook endpoints –≤ Python CRM**
   - `/api/webhooks/bitrix/order` - –ø—Ä–∏–µ–º –Ω–æ–≤—ã—Ö/–æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤
   - `/api/webhooks/bitrix/status` - –ø—Ä–∏–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏–π —Å—Ç–∞—Ç—É—Å–∞
   - `/api/sync/status` - API –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏

2. **–¢—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö**
   - `transformers/order_transformer.py` - –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä Bitrix ‚Üî Supabase
   - –ú–∞–ø–ø–∏–Ω–≥ —Å—Ç–∞—Ç—É—Å–æ–≤, –ø–æ–ª–µ–π, —Å–≤–æ–π—Å—Ç–≤ –∑–∞–∫–∞–∑–æ–≤

3. **PHP —Å–∫—Ä–∏–ø—Ç –¥–ª—è Bitrix**
   - `bitrix_webhook.php` - –≥–æ—Ç–æ–≤—ã–π –∫–æ–¥ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤ init.php
   - –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π —Å–æ–∑–¥–∞–Ω–∏—è –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑–æ–≤

4. **–û–±—Ä–∞—Ç–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è**
   - `sync_back.py` - –æ—Ç–ø—Ä–∞–≤–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π –∏–∑ CRM –æ–±—Ä–∞—Ç–Ω–æ –≤ Bitrix
   - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞

5. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥**
   - `/crm/sync` - —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
   - –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞, –ª–æ–≥–∏, –æ—à–∏–±–∫–∏

## üöÄ –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –∑–∞–ø—É—Å–∫—É

### 1. –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü –≤ Supabase

```bash
# –û—Ç–∫—Ä–æ–π—Ç–µ Supabase Dashboard ‚Üí SQL Editor
# –í—ã–ø–æ–ª–Ω–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç:
cat create_sync_tables.sql
# –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –∏ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ –≤ SQL Editor
```

### 2. –ó–∞–ø—É—Å–∫ Python CRM

```bash
cd /Users/alekenov/cvety-local/crm_python

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π (–µ—Å–ª–∏ –µ—â–µ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã)
pip install -r requirements.txt

# –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞
python app.py
# –°–µ—Ä–≤–µ—Ä –∑–∞–ø—É—Å—Ç–∏—Ç—Å—è –Ω–∞ http://localhost:8001
```

### 3. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ webhook –ª–æ–∫–∞–ª—å–Ω–æ

```bash
# –í –Ω–æ–≤–æ–º —Ç–µ—Ä–º–∏–Ω–∞–ª–µ
cd /Users/alekenov/cvety-local/crm_python

# –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Ç–µ—Å—Ç
python test_webhook.py
```

–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:
```
‚úÖ –°–µ—Ä–≤–µ—Ä Python CRM –¥–æ—Å—Ç—É–ø–µ–Ω
üöÄ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–µ—Å—Ç–æ–≤—ã–π webhook...
‚úÖ Webhook —É—Å–ø–µ—à–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω!
```

### 4. –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞

–û—Ç–∫—Ä–æ–π—Ç–µ –≤ –±—Ä–∞—É–∑–µ—Ä–µ: http://localhost:8001/crm/sync

–í—ã –¥–æ–ª–∂–Ω—ã —É–≤–∏–¥–µ—Ç—å:
- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
- –ü–æ—Å–ª–µ–¥–Ω–∏–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∑–∞–∫–∞–∑—ã
- –õ–æ–≥–∏ –æ–ø–µ—Ä–∞—Ü–∏–π

## üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –Ω–∞ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ

### 1. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ PHP –∫–æ–¥–∞ –≤ Bitrix

SSH –Ω–∞ –ø—Ä–æ–¥–∞–∫—à–Ω —Å–µ—Ä–≤–µ—Ä:
```bash
ssh root@185.125.90.141
```

–û—Ç–∫—Ä–æ–π—Ç–µ —Ñ–∞–π–ª init.php:
```bash
nano /home/bitrix/www/local/php_interface/init.php
```

–î–æ–±–∞–≤—å—Ç–µ –≤ –∫–æ–Ω–µ—Ü —Ñ–∞–π–ª–∞:
```php
// Webhook –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Python CRM
require_once(__DIR__ . '/webhook_integration.php');
```

–°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª webhook_integration.php:
```bash
nano /home/bitrix/www/local/php_interface/webhook_integration.php
```

–°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –∏–∑ `bitrix_webhook.php` –∏ –∏–∑–º–µ–Ω–∏—Ç–µ:
- `WEBHOOK_URL` –Ω–∞ –∞–¥—Ä–µ—Å –≤–∞—à–µ–≥–æ Python CRM
- `WEBHOOK_TOKEN` –Ω–∞ —Å–µ–∫—Ä–µ—Ç–Ω—ã–π —Ç–æ–∫–µ–Ω

### 2. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Python CRM –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ

–ï—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ –æ–±–ª–∞—á–Ω—ã–π —Ö–æ—Å—Ç–∏–Ω–≥ (Render, Railway):

1. –î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è:
   ```
   WEBHOOK_TOKEN=your-secret-token-here
   BITRIX_API_URL=https://cvety.kz/api/
   SYNC_ENABLED=true
   ```

2. –î–µ–ø–ª–æ–π –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å:
   ```bash
   curl https://your-app.com/api/sync/status
   ```

### 3. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ

–í Bitrix —Å–æ–∑–¥–∞–π—Ç–µ —Ç–µ—Å—Ç–æ–≤—ã–π –∑–∞–∫–∞–∑ –∏ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ:
1. –ü–æ—è–≤–∏–ª—Å—è –ª–∏ –∑–∞–∫–∞–∑ –≤ Python CRM
2. –õ–æ–≥–∏ –≤ `/home/bitrix/www/upload/webhook_log.txt`
3. –°—Ç—Ä–∞–Ω–∏—Ü—É –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –≤ CRM

## üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –æ—Ç–ª–∞–¥–∫–∞

### –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤ Bitrix:
```bash
tail -f /home/bitrix/www/upload/webhook_log.txt
```

### –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤ Python:
```bash
# –õ–æ–∫–∞–ª—å–Ω–æ
tail -f crm_python.log

# –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ systemd)
journalctl -u crm-sync -f
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ API:
```bash
curl -H "X-Webhook-Token: secret-webhook-token-2024" \
     https://your-crm.com/api/sync/status
```

## üõ†Ô∏è –£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º

### Webhook –Ω–µ –¥–æ—Ö–æ–¥—è—Ç –¥–æ Python CRM

1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ç–æ–∫–µ–Ω –≤ –æ–±–µ–∏—Ö —Å–∏—Å—Ç–µ–º–∞—Ö
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ URL –≤ PHP —Å–∫—Ä–∏–ø—Ç–µ
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ñ–∞–π—Ä–≤–æ–ª/–ø–æ—Ä—Ç—ã
4. –°–º–æ—Ç—Ä–∏—Ç–µ –ª–æ–≥–∏: `/home/bitrix/www/upload/webhook_log.txt`

### –ó–∞–∫–∞–∑—ã –Ω–µ –ø–æ—è–≤–ª—è—é—Ç—Å—è –≤ Supabase

1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ç–∞–±–ª–∏—Ü—ã `sync_mapping` –∏ `sync_log`
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ Supabase
3. –°–º–æ—Ç—Ä–∏—Ç–µ Python –ª–æ–≥–∏ –Ω–∞ –æ—à–∏–±–∫–∏ —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–∏

### –û–±—Ä–∞—Ç–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç

1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —Å–æ–∑–¥–∞–Ω –ª–∏ PHP endpoint –Ω–∞ Bitrix
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ `BITRIX_API_URL` –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
3. –°–º–æ—Ç—Ä–∏—Ç–µ `sync_log` —Ç–∞–±–ª–∏—Ü—É –Ω–∞ –æ—à–∏–±–∫–∏

## üìà –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. **–ù–∞—Å—Ç—Ä–æ–π–∫–∞ HTTPS** –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞
2. **–î–æ–±–∞–≤–ª–µ–Ω–∏–µ retry –ª–æ–≥–∏–∫–∏** –¥–ª—è failed webhooks
3. **–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∞–ª–µ—Ä—Ç–æ–≤** –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
4. **–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏** –¥–ª—è –±–æ–ª—å—à–∏—Ö –æ–±—ä–µ–º–æ–≤
5. **–î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Ç–æ–≤–∞—Ä–æ–≤ –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π**

## üìû –ü–æ–¥–¥–µ—Ä–∂–∫–∞

–ü—Ä–∏ –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏–∏ –ø—Ä–æ–±–ª–µ–º –ø—Ä–æ–≤–µ—Ä—å—Ç–µ:
- –õ–æ–≥–∏ –≤ –æ–±–µ–∏—Ö —Å–∏—Å—Ç–µ–º–∞—Ö
- –°—Ç—Ä–∞–Ω–∏—Ü—É –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ `/crm/sync`
- –¢–∞–±–ª–∏—Ü—É `sync_log` –≤ Supabase

---

**–ì–æ—Ç–æ–≤–æ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é!** üéâ